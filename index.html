<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Enhanced Product Store</title>
<style>
  /* Reset & base */
  * {
    box-sizing: border-box;
  }
  body {
    font-family: Arial, sans-serif;
    margin: 0;
    background: #f7f7f7;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }
  header {
    background: #333;
    color: white;
    padding: 1rem;
    text-align: center;
    position: sticky;
    top: 0;
    z-index: 100;
  }
  header h1 {
    margin: 0;
    font-size: 1.8rem;
  }

  /* Search bar */
  #searchBar {
    width: 100%;
    max-width: 400px;
    margin: 1rem auto;
    padding: 0.5rem;
    font-size: 1rem;
    border-radius: 4px;
    border: 1px solid #ccc;
    display: block;
  }

  /* Main container */
  main {
    flex: 1;
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1rem 2rem;
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    justify-content: center;
  }

  /* Product card */
  .product {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgb(0 0 0 / 0.1);
    padding: 1rem;
    width: 260px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    transition: transform 0.2s ease;
  }
  .product:hover {
    transform: translateY(-5px);
  }
  .product img {
    width: 100%;
    height: 180px;
    object-fit: contain;
    margin-bottom: 0.5rem;
    border-bottom: 1px solid #eee;
  }
  .product h3 {
    font-size: 1.1rem;
    margin: 0.5rem 0;
    min-height: 48px;
  }
  .product p {
    font-weight: bold;
    color: #333;
    margin: 0.5rem 0;
  }
  .product button {
    background-color: #28a745;
    border: none;
    color: white;
    padding: 0.6rem 1rem;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
    transition: background-color 0.3s ease;
  }
  .product button:hover {
    background-color: #218838;
  }

  /* Cart button fixed on top right */
  #cartBtn {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #007bff;
    color: white;
    border: none;
    padding: 0.8rem 1.3rem;
    font-size: 1rem;
    border-radius: 50px;
    cursor: pointer;
    z-index: 200;
    box-shadow: 0 4px 8px rgb(0 123 255 / 0.3);
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  #cartBtn:hover {
    background-color: #0056b3;
  }
  #cartCount {
    background: #dc3545;
    border-radius: 50%;
    padding: 0 8px;
    font-size: 0.9rem;
    font-weight: bold;
    min-width: 24px;
    text-align: center;
  }

  /* Cart modal */
  #cartModal {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background-color: rgba(0,0,0,0.5);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 300;
  }
  #cartModal.active {
    display: flex;
  }
  #cartContent {
    background: white;
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow-y: auto;
    border-radius: 8px;
    padding: 1rem;
    box-shadow: 0 8px 24px rgb(0 0 0 / 0.3);
    display: flex;
    flex-direction: column;
  }
  #cartContent h2 {
    margin-top: 0;
    text-align: center;
  }
  #closeCart {
    align-self: flex-end;
    background: transparent;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
  }

  /* Cart items */
  #cartItems {
    flex: 1;
    margin-top: 1rem;
  }
  .cart-item {
    display: flex;
    gap: 1rem;
    border-bottom: 1px solid #ddd;
    padding: 0.8rem 0;
    align-items: center;
  }
  .cart-item img {
    width: 60px;
    height: 60px;
    object-fit: contain;
    border-radius: 5px;
  }
  .cart-details {
    flex: 1;
  }
  .cart-details h4 {
    margin: 0 0 0.3rem;
  }
  .cart-details p {
    margin: 0;
    font-weight: bold;
  }
  .quantity-control {
    display: flex;
    align-items: center;
    gap: 0.3rem;
    margin-top: 0.4rem;
  }
  .quantity-control input {
    width: 50px;
    text-align: center;
    font-size: 1rem;
    border: 1px solid #ccc;
    border-radius: 4px;
  }
  .remove-btn {
    background: #dc3545;
    border: none;
    color: white;
    padding: 0.4rem 0.7rem;
    border-radius: 5px;
    cursor: pointer;
    font-size: 0.9rem;
  }
  .remove-btn:hover {
    background: #bb2d3b;
  }

  /* Cart footer */
  #cartFooter {
    margin-top: 1rem;
    text-align: right;
    font-weight: bold;
    font-size: 1.2rem;
  }
  #clearCart {
    background: #ffc107;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 5px;
    cursor: pointer;
    margin-top: 1rem;
  }
  #clearCart:hover {
    background: #e0a800;
  }

  /* Loading spinner */
  #loadingSpinner {
    width: 60px;
    height: 60px;
    border: 7px solid #ccc;
    border-top-color: #007bff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 3rem auto;
  }
  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Error message */
  #errorMessage {
    color: #dc3545;
    text-align: center;
    margin: 2rem 0;
    font-weight: bold;
  }

  /* Responsive */
  @media (max-width: 700px) {
    main {
      justify-content: center;
    }
    .product {
      width: 90vw;
    }
    #cartContent {
      max-width: 90vw;
      max-height: 90vh;
    }
  }
</style>
</head>
<body>

<header>
  <h1>My Product Store</h1>
</header>

<input type="text" id="searchBar" placeholder="Search products..." />

<main id="productContainer">
  <!-- Products will be injected here -->
</main>

<button id="cartBtn">
  Cart (<span id="cartCount">0</span>)
</button>

<div id="cartModal" aria-hidden="true">
  <div id="cartContent" role="dialog" aria-modal="true" aria-labelledby="cartTitle">
    <button id="closeCart" aria-label="Close Cart">&times;</button>
    <h2 id="cartTitle">Your Cart</h2>
    <div id="cartItems"></div>
    <div id="cartFooter">
      Total: $<span id="cartTotal">0.00</span>
    </div>
    <button id="clearCart">Clear Cart</button>
  </div>
</div>

<div id="loadingSpinner"></div>
<div id="errorMessage"></div>

<script>
  const productContainer = document.getElementById('productContainer');
  const cartBtn = document.getElementById('cartBtn');
  const cartCount = document.getElementById('cartCount');
  const cartModal = document.getElementById('cartModal');
  const closeCartBtn = document.getElementById('closeCart');
  const cartItemsContainer = document.getElementById('cartItems');
  const cartTotalEl = document.getElementById('cartTotal');
  const clearCartBtn = document.getElementById('clearCart');
  const searchBar = document.getElementById('searchBar');
  const loadingSpinner = document.getElementById('loadingSpinner');
  const errorMessage = document.getElementById('errorMessage');

  // State variables
  let products = [];
  let cart = {};

  // Load cart from localStorage
  function loadCart() {
    const savedCart = localStorage.getItem('cart');
    if (savedCart) {
      cart = JSON.parse(savedCart);
    }
  }

  // Save cart to localStorage
  function saveCart() {
    localStorage.setItem('cart', JSON.stringify(cart));
  }

  // Update cart count badge
  function updateCartCount() {
    const totalItems = Object.values(cart).reduce((sum, item) => sum + item.quantity, 0);
    cartCount.textContent = totalItems;
  }

  // Format price to 2 decimals
  function formatPrice(num) {
    return num.toFixed(2);
  }

  // Render products based on filter
  function renderProducts(filter = '') {
    productContainer.innerHTML = '';
    let filtered = products.filter(p => p.title.toLowerCase().includes(filter.toLowerCase()));
    if (filtered.length === 0) {
      productContainer.innerHTML = '<p style="text-align:center; width:100%;">No products found.</p>';
      return;
    }
    filtered.forEach(product => {
      const productEl = document.createElement('div');
      productEl.className = 'product';
      productEl.innerHTML = `
        <img loading="lazy" src="${product.image}" alt="${product.title}" />
        <h3>${product.title}</h3>
        <p>$${formatPrice(product.price)}</p>
        <button data-id="${product.id}">Add to Cart</button>
      `;
      productContainer.appendChild(productEl);
    });
  }

  // Show cart modal
  function openCart() {
    renderCartItems();
    cartModal.classList.add('active');
    cartModal.setAttribute('aria-hidden', 'false');
  }

  // Hide cart modal
  function closeCart() {
    cartModal.classList.remove('active');
    cartModal.setAttribute('aria-hidden', 'true');
  }

  // Render cart items inside modal
  function renderCartItems() {
    cartItemsContainer.innerHTML = '';
    if (Object.keys(cart).length === 0) {
      cartItemsContainer.innerHTML = '<p>Your cart is empty.</p>';
      cartTotalEl.textContent = '0.00';
      return;
    }

    let total = 0;
    Object.values(cart).forEach(item => {
      total += item.price * item.quantity;
      const cartItemEl = document.createElement('div');
      cartItemEl.className = 'cart-item';
      cartItemEl.innerHTML = `
        <img src="${item.image}" alt="${item.title}" />
        <div class="cart-details">
          <h4>${item.title}</h4>
          <p>$${formatPrice(item.price)} each</p>
          <div class="quantity-control">
            Qty: 
            <input type="number" min="1" max="99" value="${item.quantity}" data-id="${item.id}" />
          </div>
        </div>
        <button class="remove-btn" data-id="${item.id}">Remove</button>
      `;
      cartItemsContainer.appendChild(cartItemEl);
    });
    cartTotalEl.textContent = formatPrice(total);
  }

  // Add item to cart
  function addToCart(id) {
    const product = products.find(p => p.id === id);
    if (!product) return;
    if (cart[id]) {
      cart[id].quantity++;
    } else {
      cart[id] = {...product, quantity: 1};
    }
    saveCart();
    updateCartCount();
  }

  // Remove item from cart
  function removeFromCart(id) {
    delete cart[id];
    saveCart();
    updateCartCount();
    renderCartItems();
  }

  // Update quantity of cart item
  function updateQuantity(id, quantity) {
    if (quantity < 1) quantity = 1;
    if (quantity > 99) quantity = 99;
    if (cart[id]) {
      cart[id].quantity = quantity;
      saveCart();
      updateCartCount();
      renderCartItems();
    }
  }

  // Clear entire cart
  function clearCart() {
    cart = {};
    saveCart();
    updateCartCount();
    renderCartItems();
  }

  // Fetch products from free API with error handling and caching
  async function fetchProducts() {
    loadingSpinner.style.display = 'block';
    errorMessage.textContent = '';
    try {
      // Use cached data if available and less than 30 mins old
      const cache = localStorage.getItem('productCache');
      const cacheTime = localStorage.getItem('productCacheTime');
      const now = Date.now();
      if (cache && cacheTime && (now - cacheTime < 1000 * 60 * 30)) {
        products = JSON.parse(cache);
        renderProducts();
      } else {
        const res = await fetch('https://fakestoreapi.com/products');
        if (!res.ok) throw new Error('Failed to fetch products');
        products = await res.json();
        localStorage.setItem('productCache', JSON.stringify(products));
        localStorage.setItem('productCacheTime', now.toString());
        renderProducts();
      }
    } catch (error) {
      console.error(error);
      errorMessage.textContent = 'Error loading products. Please try again later.';
    } finally {
      loadingSpinner.style.display = 'none';
    }
  }

  // Event Listeners

  // Add to cart button inside product container
  productContainer.addEventListener('click', e => {
    if (e.target.tagName === 'BUTTON' && e.target.dataset.id) {
      addToCart(parseInt(e.target.dataset.id));
    }
  });

  // Open cart modal
  cartBtn.addEventListener('click', openCart);

  // Close cart modal
  closeCartBtn.addEventListener('click', closeCart);

  // Close cart when clicking outside the content
  cartModal.addEventListener('click', e => {
    if (e.target === cartModal) closeCart();
  });

  // Remove item button & quantity change in cart items container
  cartItemsContainer.addEventListener('click', e => {
    if (e.target.classList.contains('remove-btn')) {
      const id = parseInt(e.target.dataset.id);
      removeFromCart(id);
    }
  });
  cartItemsContainer.addEventListener('input', e => {
    if (e.target.tagName === 'INPUT' && e.target.type === 'number') {
      const id = parseInt(e.target.dataset.id);
      const qty = parseInt(e.target.value);
      if (!isNaN(qty)) {
        updateQuantity(id, qty);
      }
    }
  });

  // Clear cart button
  clearCartBtn.addEventListener('click', () => {
    if(confirm('Are you sure you want to clear the cart?')) {
      clearCart();
    }
  });

  // Search bar input event
  searchBar.addEventListener('input', e => {
    renderProducts(e.target.value);
  });

  // Initialization
  loadCart();
  updateCartCount();
  fetchProducts();

</script>
</body>
</html>
